---
title: "Predicting reproductive toxicity: a model for PFAS-like chemical structures"
subtitle: "BMIN503/EPID600 Final Project"
author: "Andrea Andress Huacachino"
format:
  html:
    toc: true
    toc-location: left
editor: visual
embed-resources: true
execute: 
  warning: false
  message: false
---

------------------------------------------------------------------------

### Overview

Per- and polyfluoroalkyl substances (PFAS) are a class of chemicals that pollute our environment. They are ubiquitous, and nearly in 99% of all humans on earth. Unfortunately, some members have been associated to various health outcomes, including reproductive health. Using supervised machine learning, the objective of the project is to predict the reproductive toxicity of PFAS members by characterizing their chemotypes and relating them to known biological outcomes. The data for the project was obtained from Tox 21 and  CompToxAI. Dr. Joseph Romano assisted with obtaining the data while Dr. Trevor Penning assisted by redefining the assays chosen as the biological endpoint. The project hopes to help provide more information on the toxicology of unknown PFAS as well as communicate the properties that lead to that toxicity.

All data is publicly available on my github account, TOX21, and CompToxAI.

GitHub repository: [AndreaHuacachino/BMIN503/FinalProject](https://github.com/AndreaHuacachino/BMIN503_Final_Project)

### Introduction

Environmental toxicants are man made chemicals that are present in our environment due to industry and manufacturing plants. Many of these compounds are detrimental to human health. PFAS are a class of organofluorine compounds containing multiple fluorine atoms attached to an alkyl chain. These compounds differ in connectivity or carbon chain length. There exist nearly 15,000 synthetic chemicals, reported by the U.S. Environmental Protection Agency. The most famous example is perfluorooctanoic acid (PFOA), a prolific toxicant. It\'s production was widespread in the US until its ban in the 1990\'s. It is known to be an endocrine disrupting chemical (EDC) which are toxicants that lead to hormone regulation dysregulation. 

Structure activity relation (QSAR) studies are based on the chemical hypothesis that the structure of a molecule contains the necessary information as to how it will interact with a target (often times a protein), thus linking the molecule to a chemical or biological process. SAR studies are a well known tool in the pharmaceutical field to develop small molecule drugs for various symptoms and diseases. Quantitative (Q)SAR is a special case of SAR where relationships become quantified. QSAR is particularly important in predictions, often using machine learning approaches to build strong models. Of the possible algorithms to use, QSAR studies have historically relied on random forest due to its collection of desired features.

Due to growing scrutiny by civilian and governmental organizations, many legacy PFAS have been pressured to be rolled back. However, in order to maintain profits, producers have been creating new PFAS. Many of the new "next generation" PFAS take advantage of the lack of toxicological data available to claim to be safer, despite no studies suggesting safety. The necessity for predicting toxicity from PFAS structure knowledge is then evident. The significance of my project is to create a machine learning model to predict toxicity in novel PFAS for the ultimate goal to prioritize further studies and to help guide PFAS production towards a less toxic future. 

This research question is interdisciplinary by nature due to its ties with environmental toxicology. The field of environmental toxicology encompasses the fields of biology, chemistry, statistics, medicine, and recently, computer science. Advances in computer science have allowed predictive toxicology, a subset of toxicology, to flourish. This project falls within the field of predictive toxicology.

### Methods

Describe the data used and general methodological approach. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why.

**Loading in Packages**

```{r}
#| eval: FALSE

#install.packages("kernlab")
#install.packages("randomForest")
#install.packages("glmnet")
#install.packages("tidymodels")
#install.packages("dotwhisker")
#install.packages("vip")




library(tidyverse)
library(kernlab)
library(randomForest)
library(glmnet)
library(tidymodels)
tidymodels_prefer()
library(dotwhisker)
library(vip)

```

**Reading in Files**

All files have been retrieved from [CompToxAI](https://comptox.ai/data.html) and [Tox21](https://tripod.nih.gov//tox21/pubdata/). Once downloaded onto my computer, I uploaded the files on my github in order for the data to be publicly available in an ordered csv file. Each file contains structural data pertaining to the chemical entity and toxicity by showing if it interacted with the target or not. First column is the chemical ID, then columns 2-167 are structural data of the chemical, finally column 168 is if it interacted with the target, 0 for nontoxic, 1 for toxic.

```{r}

#Descriptors in file name: protocol, target, cell type, agonist or antagonist
 

#Androgen receptor (AR) based assays 

ar_bla_agonist_p1 <- read.csv('https://raw.githubusercontent.com/AndreaHuacachino/BMIN503_Final_Project/master/andrea_tox21-ar-bla-agonist-p1.csv', header = TRUE)

ar_bla_antagonist_p1 <- read.csv('https://raw.githubusercontent.com/AndreaHuacachino/BMIN503_Final_Project/master/andrea_tox21-ar-bla-antagonist-p1.csv', header = TRUE)

ar_mda_kb2_luc_agonist_p1 <- read.csv('https://raw.githubusercontent.com/AndreaHuacachino/BMIN503_Final_Project/master/andrea_tox21-ar-mda-kb2-luc-agonist-p1.csv', header = TRUE)

ar_mda_kb2_luc_agonist_p3 <- read.csv('https://raw.githubusercontent.com/AndreaHuacachino/BMIN503_Final_Project/master/andrea_tox21-ar-mda-kb2-luc-agonist-p3.csv', header = TRUE)

ar_mda_kb2_luc_antagonist_p1 <- read.csv('https://raw.githubusercontent.com/AndreaHuacachino/BMIN503_Final_Project/master/andrea_tox21-ar-mda-kb2-luc-antagonist-p1.csv', header = TRUE)

ar_mda_kb2_luc_antagonist_p2 <- read.csv('https://raw.githubusercontent.com/AndreaHuacachino/BMIN503_Final_Project/master/andrea_tox21-ar-mda-kb2-luc-antagonist-p2.csv', header = TRUE)



#Estrogen Receptor Assays

er_bla_agonist_p2 <- read.csv('https://raw.githubusercontent.com/AndreaHuacachino/BMIN503_Final_Project/master/andrea_tox21-er-bla-agonist-p2.csv', header = TRUE)

er_bla_antagonist_p1 <- read.csv('https://raw.githubusercontent.com/AndreaHuacachino/BMIN503_Final_Project/master/andrea_tox21-er-bla-antagonist-p1.csv', header = TRUE)

er_luc_bg1_4e2_agonist_p2 <- read.csv('https://raw.githubusercontent.com/AndreaHuacachino/BMIN503_Final_Project/master/andrea_tox21-er-luc-bg1-4e2-agonist-p2.csv', header = TRUE)

er_luc_bg1_4e2_agonist_p4 <- read.csv('https://raw.githubusercontent.com/AndreaHuacachino/BMIN503_Final_Project/master/andrea_tox21-er-luc-bg1-4e2-agonist-p4.csv', header = TRUE)

er_luc_bg1_4e2_antagonist_p1 <- read.csv('https://raw.githubusercontent.com/AndreaHuacachino/BMIN503_Final_Project/master/andrea_tox21-er-luc-bg1-4e2-antagonist-p1.csv', header = TRUE)

er_luc_bg1_4e2_antagonist_p2 <- read.csv('https://raw.githubusercontent.com/AndreaHuacachino/BMIN503_Final_Project/master/andrea_tox21-er-luc-bg1-4e2-antagonist-p2.csv', header = TRUE)

# Estrogen Receptor subtype: beta
erb_bla_antagonist_p1 <- read.csv('https://raw.githubusercontent.com/AndreaHuacachino/BMIN503_Final_Project/master/andrea_tox21-erb-bla-antagonist-p1.csv', header = TRUE)

erb_bla_p1 <- read.csv('https://raw.githubusercontent.com/AndreaHuacachino/BMIN503_Final_Project/master/andrea_tox21-erb-bla-p1.csv', header = TRUE)



#PPAR-gamma Assays

pparg_bla_agonist_p1 <- read.csv('https://raw.githubusercontent.com/AndreaHuacachino/BMIN503_Final_Project/master/andrea_tox21-pparg-bla-agonist-p1.csv', header = TRUE)

pparg_bla_antagonist_p1 <- read.csv('https://raw.githubusercontent.com/AndreaHuacachino/BMIN503_Final_Project/master/andrea_tox21-pparg-bla-antagonist-p1.csv', header = TRUE)


head(ar_bla_agonist_p1)
```

Making random forest engine

```{r}


#general
rf_cls_spec <- 
  rand_forest(trees = 100, min_n = 5) |> 
  set_engine("randomForest", importance = TRUE) |>
  set_mode("classification")
rf_cls_spec


#ar_bla_agonist_p1

#making dataset include factors
ar_bla_agonist_p1.2 <- ar_bla_agonist_p1 |>
  mutate(target = factor(target, levels = c("0", "1"), 
                           labels = c("0","1")))


ar_bla_agonist_p1.2$target


#Making model of ar_bla_agonist_p1
ar_bla_agonist_p1.rf_cls_fit <- rf_cls_spec |>
  fit(target ~ ., data = ar_bla_agonist_p1.2)


#gini_importance score
ar_bla_agonist_p1.gini_importance <- vip(ar_bla_agonist_p1.rf_cls_fit)
ar_bla_agonist_p1.gini_importance


#predictions 
ar_bla_agonist_p1.rf.pred.values <- bind_cols(
  truth = ar_bla_agonist_p1.2$target,
  predict(ar_bla_agonist_p1.rf_cls_fit, ar_bla_agonist_p1.2),
  predict(ar_bla_agonist_p1.rf_cls_fit, ar_bla_agonist_p1.2, type = "prob"))

#I keep getting Error in predict.randomForest(object = object$fit, newdata = new_data) : New factor levels not present in the training data SAD 




autoplot(roc_curve(ar_bla_agonist_p1.rf.pred.values, 
                   truth, .pred_died))



#cross validation stuff

rf_workflow <-
  workflow() |>
  add_model(rf_cls_spec) |>
  add_formula(target ~ .)

set.seed(1234)
rf_fit_cv <-
  rf_workflow |>
  fit_resamples(titanic.training.folds, 
                control = control_resamples(save_pred = TRUE))

collect_metrics(rf_fit_cv)

rf_fit_cv |>
  collect_predictions() |>
  roc_curve(survived, .pred_died) |>
  autoplot()
```

### Results

Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.

**Conclusion**
